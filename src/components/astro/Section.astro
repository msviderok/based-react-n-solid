---
import { SolidComponent } from "@/components/solid";

interface Props {
  compName: string;
  variants: string[];
}

const { compName, variants } = Astro.props;
---

<astro-section data-component={compName}>
  <section
    data-section-root
    data-component={compName}
    class="transition-all duration-200 mb-4 flex-auto"
  >
    <button
      data-section-button
      class="flex items-center px-3 py-2 font-mono text-xs rounded-sm hover:transition-all border mb-4"
    >
      <div class="flex items-center">
        <span data-accent="left" class="text-blue-400/30 mr-0.5">&lt;</span>
        <span class="text-foreground font-mono">
          {
            compName
              .split("-")
              .map((part) => part.charAt(0).toUpperCase() + part.slice(1))
              .join("")
          }
        </span>
        <span data-accent="right" class="text-blue-400/40 ml-0.5">/&gt;</span>
      </div>
    </button>

    <div data-panel class="comparison-container space-y-8 py-6">
      {
        variants.map((variant) => (
          <div class="space-y-4">
            <h3
              data-variant-label
              class="flex items-center gap-3 font-mono text-[11px] uppercase tracking-[0.22em] text-muted-foreground/60"
            >
              <span class="h-px w-6 bg-border/40" aria-hidden="true" />
              <span>{variant.replace("-", " ")}</span>
            </h3>
            <div class="comparison-grid grid gap-6 bg-black/40/80 p-4 py-6 sm:py-8 rounded-md border border-white/5 shadow-[0_0_0_1px_rgba(148,163,184,0.15)]">
              <div class="flex flex-1 flex-col gap-2">
                <span class="text-[11px] font-mono font-semibold uppercase tracking-[0.2em] text-muted-foreground/70">
                  Solid
                </span>
                <div class="flex flex-1 items-center justify-center">
                  <SolidComponent component={compName} type={variant} client:only="solid-js" />
                </div>
              </div>
              <div class="comparison-divider bg-border/40 w-full h-px my-3" aria-hidden="true" />
              <div class="flex flex-1 flex-col gap-2">
                <span class="text-[11px] font-mono font-semibold uppercase tracking-[0.2em] text-muted-foreground/70">
                  React
                </span>
                <div class="flex flex-1 items-center justify-center">
                  <SolidComponent component={compName} type={variant} client:only="solid-js" />
                </div>
              </div>
            </div>
          </div>
        ))
      }
    </div>
  </section>
</astro-section>

<script>
  import { toggleSection, allSectionsOpen, sections, styling } from "@/store";
  import { effect, computed } from "nanostores";

  class AstroSection extends HTMLElement {
    connectedCallback() {
      const compName = this.dataset.component!;
      const button = this.querySelector("button") as HTMLButtonElement;
      const leftAccent = this.querySelector("span[data-accent='left']") as HTMLSpanElement;
      const rightAccent = this.querySelector("span[data-accent='right']") as HTMLSpanElement;
      const panel = this.querySelector("div[data-panel]")! as HTMLDivElement;
      const variantLabels = this.querySelectorAll(
        "h3[data-variant-label]"
      ) as NodeListOf<HTMLHeadingElement>;
      const store = computed(sections, (sections) => sections[compName]);

      const sectionRoot = this.querySelector("[data-section-root]") as HTMLElement;

      button.addEventListener("click", () => {
        toggleSection(compName);
      });
      effect([store, allSectionsOpen, styling], ({ open }, allOpen, style) => {
        const isOpen = open || allOpen;
        const isCssModules = style === "CssModules";

        panel.style.display = isOpen ? "block" : "none";
        button.classList.toggle("mb-8", isOpen);
        button.setAttribute("aria-checked", isOpen.toString());

        // Reset gradient / border / shadow classes before applying state-specific ones
        button.classList.remove(
          "bg-gradient-to-r",
          "bg-gradient-to-t",
          "from-blue-400/5",
          "border-blue-400/20",
          "from-purple-400/5",
          "border-purple-400/20",
          "from-blue-500/30",
          "from-blue-500/20",
          "from-blue-500/15",
          "from-transparent",
          "to-transparent",
          "border-blue-500/20",
          "border-blue-500/15",
          "shadow-lg",
          "shadow-blue-500/10",
          "shadow-blue-500/5",
          "from-purple-500/30",
          "from-purple-500/20",
          "from-purple-500/15",
          "border-purple-500/20",
          "border-purple-500/15",
          "shadow-purple-500/10",
          "shadow-purple-500/5"
        );

        if (isOpen) {
          // Gradient only for active pills, softer at the bottom (to top)
          if (isCssModules) {
            button.classList.add(
              "bg-gradient-to-t",
              "from-purple-500/15",
              "to-transparent",
              "border-purple-500/15",
              "shadow-lg",
              "shadow-purple-500/5"
            );
          } else {
            button.classList.add(
              "bg-gradient-to-t",
              "from-blue-500/15",
              "to-transparent",
              "border-blue-500/15",
              "shadow-lg",
              "shadow-blue-500/5"
            );
          }
        } else {
          // Inactive pills: no gradient, just subtle borders
          if (isCssModules) {
            button.classList.add("border-purple-400/20");
          } else {
            button.classList.add("border-blue-400/20");
          }
        }
      });

      styling.subscribe((value) => {
        const isCssModules = value === "CssModules";

        leftAccent.classList.toggle("text-blue-400/30", !isCssModules);
        leftAccent.classList.toggle("text-purple-400/30", isCssModules);

        rightAccent.classList.toggle("text-blue-400/40", !isCssModules);
        rightAccent.classList.toggle("text-purple-400/40", isCssModules);

        // Sync variant labels with current styling accent, very subtly (typography only)
        variantLabels.forEach((label) => {
          label.classList.remove("text-blue-300", "text-purple-300");

          if (isCssModules) {
            label.classList.add("text-purple-300");
          } else {
            label.classList.add("text-blue-300");
          }
        });
      });
    }
  }

  customElements.define("astro-section", AstroSection);
</script>

<style>
  astro-section {
    /* Make each section act as its own sizing container */
    container-type: inline-size;
    container-name: section-container;

    /* Play nicely in multi-column / masonry-style layouts */
    break-inside: avoid;
    page-break-inside: avoid;
    -webkit-column-break-inside: avoid;
    margin-bottom: 1.5rem;
    display: block;
  }

  /* Container query: when the section column is wide enough, switch to side-by-side layout */
  @container section-container (min-width: 36rem) {
    .comparison-grid {
      grid-template-columns: minmax(0, 1fr) auto minmax(0, 1fr);
      gap: 1.5rem;
      align-items: stretch;
    }

    .comparison-divider {
      width: 1px;
      height: 100%;
      margin: 0 auto;
    }
  }
</style>
